ä¸ªäººåšå®¢ä¹‹å‰å·²ç»å°† vue-router çš„æ¨¡å¼æ”¹ä¸ºäº† `history`ï¼Œå³ url ä¸­ä¸åŒ…å« `hash`ï¼Œå†é€šè¿‡å°†æ‰€æœ‰çš„é™æ€è¯·æ±‚è½¬å‘åˆ° index.htmlï¼Œä½¿å®ƒçœ‹ä¸Šå»ä¼¼ä¹åƒä¸€ä¸ªé™æ€å¤šé¡µçš„ç½‘ç«™ã€‚

ç„¶è€Œï¼Œå®ƒå…¶å®å’Œå…¶ä»–çš„ SPA (Single Page Application å•é¡µåº”ç”¨)æ¥è¯´æ²¡æœ‰ä»»ä½•çš„åŒºåˆ«ï¼Œæœ€ç»ˆæ˜¯é€šè¿‡å‰ç«¯çš„è·¯ç”±å»æ§åˆ¶é¡µé¢çš„æ˜¾ç¤ºã€‚å•é¡µåº”ç”¨è™½ç„¶åœ¨äº¤äº’ä½“éªŒä¸Šæ¯”ä¼ ç»Ÿå¤šé¡µæ›´å‹å¥½ï¼Œä½†å®ƒä¹Ÿæœ‰ä¸€ä¸ªå¤©ç”Ÿçš„ç¼ºé™·ï¼Œå°±æ˜¯å¯¹æœç´¢å¼•æ“ä¸å‹å¥½ï¼Œä¸åˆ©äºçˆ¬è™«çˆ¬å–æ•°æ®ã€‚

æ­£æ‰€è°“æˆä¹Ÿè§ä½•ï¼Œè´¥ä¹Ÿè§ä½•ã€‚

è®²äººè¯å°±æ˜¯ï¼Œæœç´¢å¼•æ“æœä¸åˆ°æˆ‘çš„åšå®¢å•Š~å“­...

é‚£ä»€ä¹ˆå¯¹æœç´¢å¼•æ“å’Œçˆ¬è™«å‹å¥½çš„å“ªï¼Ÿç­”æ¡ˆå°±æ˜¯é™æ€é¡µï¼Œè€Œéæµè§ˆå™¨æ¸²æŸ“ï¼Œè¿™å°±éœ€è¦æœåŠ¡å™¨ç›´æ¥æ¸²æŸ“ï¼Œä¹Ÿå°± SSR(Server Side Render)ã€‚

![å½“ç„¶ä¸æ˜¯è¿™ä¸ª SSR](http://o7nu3cbe9.bkt.clouddn.com/blog/ssr/ssr.jpg) 

SSRï¼ŒæœåŠ¡å™¨æ¸²æŸ“ã€‚ç®€å•æ¥è¯´å°±æ˜¯ï¼ŒæœåŠ¡å™¨å°†æ¯ä¸ªè¦å±•ç¤ºçš„é¡µé¢éƒ½è¿è¡Œå®Œæˆåï¼Œå°†æ•´ä¸ªç›¸åº”æµä¼ é€ç»™æµè§ˆå™¨ï¼Œæ‰€æœ‰çš„è¿ç®—åœ¨æœåŠ¡å™¨ç«¯éƒ½å·²ç»å®Œæˆï¼Œæµè§ˆå™¨åªéœ€è¦è§£æ HTML å°±è¡Œã€‚

è¯´èµ·æ¥ç®€å•ï¼Œé‚£åˆ°åº•è¯¥å¦‚ä½•ç€æ‰‹å°†é¡¹ç›®æ”¹é€ æˆ SSRï¼Œå’Œæ›¾ç»çš„å¤šé¡µåˆæœ‰ä»€ä¹ˆåŒºåˆ«å“ªï¼Ÿæ—¢ç„¶è‡ªå·±åœ¨ SSR æ–¹é¢æ˜¯ä¸ªå°ç™½ï¼Œè‡ªç„¶è¦å…ˆä»æŸ¥èµ„æ–™çœ‹æ–‡æ¡£å…¥æ‰‹ï¼ŒVue 2.0 çš„æ–‡æ¡£ä¸­æœ‰ä¸€ç« å°±æ˜¯å…³äº [SSR](https://vuejs.org/v2/guide/ssr.html)ã€‚

çœ‹äº†æ–‡æ¡£ä¹‹åï¼Œå®ƒç»™äº†æˆ‘ä¸€ä¸ªæ–°æ€è·¯ï¼Œå¯ä»¥åœ¨æ— é¡»å¤§å¹…ä¿®æ”¹åŸå…ˆä»£ç çš„æƒ…å†µä¸‹åšåˆ° SSRï¼Œåˆä¸å¤±å•é¡µè‰¯å¥½çš„ä½“éªŒã€‚

å¬ä¸Šå»å¾ˆé…·æ˜¯ä¸æ˜¯ï¼Œå…·ä½“æ€ä¹ˆåšç»§ç»­çœ‹ä¸‹å»ã€‚

## SSR Architecture

ä¸€ä¸ªæ™®é€šçš„å•é¡µåº”ç”¨é€šå¸¸æ˜¯é€šè¿‡ webpack å°†æºä»£ç æ‰“åŒ…åæ’å…¥åˆ° html ä¸­ï¼Œå½“é¡µé¢è¯·æ±‚æ—¶ï¼Œè¿”å› html å†åŠ è½½æ‰“åŒ…åçš„ js æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¸‹å›¾ä¸­çš„ Application Codeï¼ŒWebpack build å’Œ browser è¿™ä¸‰å¤§å—ã€‚

![SSR Architecture](http://o7nu3cbe9.bkt.clouddn.com/blog/ssr/ssr-architecture.png)

å‰©ä¸‹çš„é‚£å‡ éƒ¨åˆ†å°±æ˜¯ SSR éœ€è¦é¢å¤–æ–°åŠ çš„éƒ¨åˆ†ï¼Œä¸€ä¸ªä¸ªæ¥çœ‹ã€‚

### Server entry & Client entry

Server entry & client entry ä¸¤è€…çš„æœ‰å…±åŒçš„è¯å°¾ entryï¼Œå¯¹åº”çš„æ˜¯ webpack.config ä¸­çš„ entryï¼Œå³æ‰“åŒ…å…¥å£æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯åˆ†åˆ«ä»£è¡¨æœåŠ¡å™¨ç«¯æ‰€è¿è¡Œä»£ç çš„å…¥å£å’Œæµè§ˆå™¨ç«¯æ‰€è¿è¡Œä»£ç çš„å…¥å£æ–‡ä»¶ã€‚

å…¥å£æ–‡ä»¶è‡ªç„¶ä¸ç”¨å¤šå¤æ‚ã€‚

* server entry: æ ¹æ®è·¯ç”±çŠ¶æ€ï¼Œè¿”å›æ¸²æŸ“å®Œæˆåç›¸åº”çš„ç»„ä»¶
* clinet entry: å°†åº”ç”¨ç›´æ¥æŒ‚è½½åˆ° DOM ä¸Š

OKã€‚å®ƒä¿©çš„äº‹å°±åšå®Œå•¦ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ã€‚

### Webpack build

æœ‰äº†ä¸åŒçš„ entryï¼Œæ‰“åŒ…çš„å†…å®¹ä¹Ÿæœ‰ä¸åŒï¼Œè‡ªç„¶å°±è¦ä¸¤å¥—é…ç½®ã€‚

é…ç½® webpack çš„é…ç½®æ–‡ä»¶çš„ç¡®å¾ˆéº»çƒ¦ï¼Œä½†æœ‰ä¸ªå¥½æ¶ˆæ¯å°±æ˜¯åŸå…ˆçš„æ‰“åŒ…æ–‡ä»¶ä¸éœ€è¦ä¿®æ”¹ï¼Œåªéœ€åŠ ä¸€ä¸ª server ç«¯çš„é…ç½®æ–‡ä»¶å°±å¯ä»¥äº†ã€‚server ç«¯çš„é…ç½®æ–‡ä»¶ä¹Ÿç›¸å½“ç®€å•ï¼ŒåŸºæœ¬å¯ä»¥æ²¿ç”¨å®¢æˆ·ç«¯çš„é…ç½®ï¼Œæ”¹æ”¹ `entry` å’Œ `output` åŸºæœ¬å°±å·®ä¸å¤šäº†ã€‚

ä¸è¿‡ï¼Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œä¸€å®šè¦å°† `target` å±æ€§è®¾ç½®æˆ `node`ï¼Œä¸ç„¶æ‰“åŒ…å®Œäº†ä¹Ÿæ²¡æ³•åœ¨ node ç¯å¢ƒä¸‹è·‘ã€‚è¿˜å¯ä»¥å°†æ‰€æœ‰ä¾èµ–éƒ½è®¾ç½®æˆ `externals`ï¼ˆè·‘åœ¨æœåŠ¡å™¨æœ¬åœ°å˜›ï¼Œä¾èµ–è‡ªç„¶éƒ½æ‹¿å¾—åˆ°ï¼‰ï¼Œè¿™åªæ˜¯ä¸ªä¼˜åŒ–ç‚¹ï¼Œä¸åŠ ä¹Ÿæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚

æœ‰äº†é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå°±èƒ½ç”Ÿæˆ Server Bundle äº†ï¼Œåªå‰©ä¸‹æœ€åä¸€å— Bundle Renderer äº†ã€‚

### Bundle Renderer

åˆ°è¿™é‡Œæ‰è¦ç”¨ä¸Š vue ä¸ºæ”¯æŒ ssr æ‰€ä¾èµ–çš„åº“ `vue-server-renderer`ã€‚

é€šè¿‡ `vue-server-renderer` æä¾›çš„ [API](https://github.com/vuejs/vue/blob/dev/packages/vue-server-renderer/README.md) å°±èƒ½å®¹æ˜“åœ°æ ¹æ® url ç”Ÿæˆå¯¹åº”çš„ç»„ä»¶æ ‘ï¼Œç„¶åå°†å®ƒè¿”å›ç»™å®¢æˆ·ç«¯ã€‚

è¿™é‡Œè¦æ³¨æ„ï¼Œå› ä¸ºç”¨çš„æ˜¯ webpack æ‰“åŒ…åçš„æ–‡ä»¶ï¼Œæ‰€ä»¥åªèƒ½ç”¨ `createBundleRenderer` è€Œä¸èƒ½ç”¨ `createRenderer` æ¥åˆ›å»º rendererã€‚

åˆ›å»º renderer çš„æ—¶å€™è¿˜å¯ä»¥ä¸ºå®ƒé…ç½® cacheï¼Œæ–¹æ³•åœ¨ [README](https://github.com/vuejs/vue/blob/dev/packages/vue-server-renderer/README.md) ä¸­ä¹Ÿå†™å¾—å¾ˆæ¸…æ¥šäº†ï¼Œç”±äºæˆ‘ä¸ªäººåšå®¢çš„åœºæ™¯ä¸é€‚åˆæ·»åŠ  cache å°±æ²¡æœ‰æ·»åŠ ã€‚

è¿™æ ·ä» SPA åˆ° SSR çš„å˜æ›´å°±å®Œæˆäº†ï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—®çœ‹çœ‹æ˜¯ä¸æ˜¯å·²ç»å°†é¡µé¢æ•´ä¸ªè¿”å›äº†ã€‚

### Tips

* é‡åˆ°æ§åˆ¶å° âš ï¸

> The client-side rendered virtual DOM tree is not matching server-rendered content. 

å½“ç„¶ï¼Œå¯èƒ½æ˜¯ä½ çš„æ ‡ç­¾ä¸å¯¹åº”ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ text node ä¸­çš„ç©ºæ ¼å­—ç¬¦é•¿åº¦ä¸å¯¹åº”ï¼Œæˆ‘ä¸ªäººé‡åˆ°çš„éƒ½æ˜¯ç©ºæ ¼ä¸å¯¹åº”é€ æˆçš„é—®é¢˜ï¼Œå¾ˆæ˜¯å°´å°¬ï¼ˆå¯èƒ½æ˜¯ä½¿ç”¨ template è¯­æ³•é€ æˆçš„ï¼‰...

* Memory-fs

åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œç”±äºä½¿ç”¨æœåŠ¡å™¨æ¸²æŸ“ï¼Œè‡ªç„¶ä¸èƒ½ä½¿ç”¨ webpack-dev-serverï¼Œè€Œæ˜¯è¦ç”¨ webpack-dev-middlewareã€‚ç„¶è€Œï¼Œwebpack-dev-middleware æ‰€åˆ›å»ºçš„æ–‡ä»¶éƒ½æ˜¯åœ¨å†…å­˜é‡Œçš„ï¼Œserver å°±æ— æ³•è¯»åˆ° server bundle æ–‡ä»¶ï¼Œè¿™é‡Œå°±è¦ç”¨åˆ° [memory-fs](https://github.com/webpack/memory-fs) æ¥ä»å†…å­˜ä¸­è¯»æ–‡ä»¶ã€‚

* KOA 2

ç”¨ koa 2 ä½œä¸ºæœåŠ¡å™¨æ—¶ï¼Œåœ¨ `renderToString` æˆ– `renderToStream` æ—¶ï¼Œè®°å¾—å¤–é¢è¦åŠ  `await`ï¼Œå¦åˆ™ï¼Œç¨‹åºå°±ä¸ç­‰ç»„ä»¶æ¸²æŸ“å¥½ï¼Œå°±ç›´æ¥è·‘ä¸‹ä¸ª middleware å»äº†ã€‚

### å®Œæˆ
è¿™æ ·å½“æµè§ˆå™¨è¯·æ±‚æ—¶ï¼Œè¿”å›çš„é¡µé¢æ˜¯æœåŠ¡å™¨æ¸²æŸ“ä¹‹åçš„ï¼Œæµè§ˆå™¨è§£æåï¼Œé¡µé¢ä»å°±æ˜¯ä¸€ä¸ªå•é¡µåº”ç”¨ã€‚

æœ€åï¼Œçœ‹æ•ˆæœçš„æˆ³[è¿™é‡Œ](http://discipled.daoapp.io/)ï¼Œçœ‹ä»£ç çš„æˆ³[è¿™é‡Œ](https://github.com/DiscipleD/blog)ï¼ŒåŸå…ˆ SPA çš„ä»£ç ä¾æ—§ä¿ç•™åœ¨äº† [SPA åˆ†æ”¯](https://github.com/DiscipleD/blog/tree/SPA)ã€‚

å¯¹ Vue SSR æœ‰å…´è¶£çš„ç«¥é‹ï¼Œä¸€å®šè¦çœ‹çœ‹ [vue hackernews 2.0](https://github.com/vuejs/vue-hackernews-2.0)ï¼Œå¤§ç¥çš„æ°´å‡†æ¯”æˆ‘å¯æ˜¯é«˜å¤šäº†ã€‚

æœ€åçš„æœ€åï¼Œåæ§½ä¸‹ Daocloudï¼Œæœ€è¿‘è€æŒ‚æˆ‘æœåŠ¡å™¨ï¼Œæ‰æˆ‘ä¸€ç›´ä¸ºå®ƒè¯´å¥½è¯ã€‚

è‡ªå·±å†™å®Œï¼Œçœ‹çœ‹æ„Ÿè§‰å¥½ç®€å•ï¼Œä¸ºä»€ä¹ˆè¿˜æäº†é‚£ä¹ˆä¹…...

![](http://o7nu3cbe9.bkt.clouddn.com/blog/ssr/transfixed.jpg)

å¸¸è¨€é“ï¼šé¥­ä¸èƒ½ä¸€æ—¥ä¸åƒï¼Œåšå®¢ä¸èƒ½ä¸€æœˆä¸å‘...å·®ç‚¹å°±ç ´ä¾‹äº†ï¼ˆğŸƒ
